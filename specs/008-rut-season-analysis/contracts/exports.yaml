# API Contract: Export Services
# Feature: 008-rut-season-analysis
# Purpose: PDF report generation and ZIP archive export

openapi: 3.0.3
info:
  title: Export Services API
  description: Generate PDF reports and ZIP archives of detection datasets
  version: 1.0.0

paths:
  /api/exports/pdf:
    post:
      summary: Generate PDF report (async)
      description: |
        Create PDF report with charts, statistics tables, and plain language insights.
        Processing is asynchronous - returns job_id for status polling.

        Report includes:
        - Detection timeline charts (Recharts rendered as PNG)
        - Statistics tables (detection counts, confidence scores)
        - Plain language summary (peak activity, sex ratios, trends)
        - Multi-page layout with automatic pagination

        Target: <10 seconds generation time, <5MB file size
      operationId: createPDFReport
      tags:
        - Exports
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - report_type
                - start_date
                - end_date
              properties:
                report_type:
                  type: string
                  enum:
                    - seasonal_activity
                    - comparison
                    - custom
                  example: seasonal_activity
                  description: |
                    Report template type:
                    - seasonal_activity: Single period analysis
                    - comparison: Multi-period side-by-side
                    - custom: User-defined content (future)

                start_date:
                  type: string
                  format: date
                  example: "2024-09-01"
                  description: Report start date (YYYY-MM-DD)

                end_date:
                  type: string
                  format: date
                  example: "2025-01-31"
                  description: Report end date (YYYY-MM-DD)

                comparison_periods:
                  type: array
                  minItems: 2
                  maxItems: 5
                  items:
                    type: object
                    required:
                      - start_date
                      - end_date
                      - label
                    properties:
                      start_date:
                        type: string
                        format: date
                      end_date:
                        type: string
                        format: date
                      label:
                        type: string
                  description: |
                    Required if report_type='comparison'. Define 2-5 periods to compare.

                include_charts:
                  type: boolean
                  default: true
                  description: Embed timeline charts (PNG images)

                include_tables:
                  type: boolean
                  default: true
                  description: Include statistics tables

                include_insights:
                  type: boolean
                  default: true
                  description: Include plain language summary and highlights

                group_by:
                  type: string
                  enum: [month, week, day]
                  default: month
                  description: Chart granularity

                classifications:
                  type: array
                  items:
                    type: string
                    enum: [doe, fawn, mature, mid, young, cattle, pig, raccoon]
                  description: Filter to specific classifications (default: all deer)

                title:
                  type: string
                  example: "Rut Season 2024 Activity Report"
                  description: Report title (default: auto-generated from date range)

            examples:
              seasonal_activity_report:
                summary: Generate rut season activity PDF
                value:
                  report_type: "seasonal_activity"
                  start_date: "2024-09-01"
                  end_date: "2025-01-31"
                  include_charts: true
                  include_tables: true
                  include_insights: true
                  group_by: "month"
                  title: "Rut Season 2024 Analysis"

              comparison_report:
                summary: Generate 3-period comparison PDF
                value:
                  report_type: "comparison"
                  start_date: "2024-09-01"
                  end_date: "2025-01-31"
                  comparison_periods:
                    - start_date: "2024-09-01"
                      end_date: "2024-09-30"
                      label: "September (Pre-Rut)"
                    - start_date: "2024-11-01"
                      end_date: "2024-11-30"
                      label: "November (Peak Rut)"
                    - start_date: "2025-01-01"
                      end_date: "2025-01-31"
                      label: "January (Post-Rut)"
                  include_charts: true
                  include_tables: true
                  include_insights: true
                  title: "Rut Season Progression Analysis"

      responses:
        '202':
          description: Export job created (processing asynchronously)
          content:
            application/json:
              schema:
                type: object
                required:
                  - job_id
                  - status
                  - message
                properties:
                  job_id:
                    type: string
                    format: uuid
                    example: "pdf-12345678-1234-1234-1234-123456789012"
                    description: Use this ID to poll status endpoint
                  status:
                    type: string
                    enum: [pending, processing]
                    example: "processing"
                  message:
                    type: string
                    example: "PDF report generation started. Poll /api/exports/pdf/{job_id} for status."
                  estimated_completion:
                    type: string
                    format: date-time
                    description: Estimated finish time (usually 5-10 seconds from now)

              example:
                job_id: "pdf-12345678-1234-1234-1234-123456789012"
                status: "processing"
                message: "PDF report generation started. Poll /api/exports/pdf/{job_id} for status."
                estimated_completion: "2025-11-08T12:35:10Z"

        '400':
          description: Invalid request
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
              examples:
                missing_comparison_periods:
                  value:
                    error: "Invalid request"
                    detail: "comparison_periods required when report_type='comparison'"

        '500':
          description: Server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /api/exports/pdf/{job_id}:
    get:
      summary: Check PDF generation status
      description: |
        Poll this endpoint to check if PDF report is ready for download.
        Frontend should poll every 2-3 seconds until status='completed'.
      operationId: getPDFStatus
      tags:
        - Exports
      parameters:
        - name: job_id
          in: path
          required: true
          schema:
            type: string
            format: uuid
          description: Job ID from POST /api/exports/pdf response

      responses:
        '200':
          description: Job status retrieved
          content:
            application/json:
              schema:
                type: object
                required:
                  - job_id
                  - status
                properties:
                  job_id:
                    type: string
                    format: uuid
                  status:
                    type: string
                    enum: [pending, processing, completed, failed, expired]
                  download_url:
                    type: string
                    format: uri
                    example: "/api/exports/pdf/pdf-12345678.../download"
                    description: Available when status='completed'
                  file_size_bytes:
                    type: integer
                    example: 3456789
                    description: PDF file size (available when completed)
                  error_message:
                    type: string
                    description: Error details (only if status='failed')
                  created_at:
                    type: string
                    format: date-time
                  completed_at:
                    type: string
                    format: date-time
                    nullable: true
                  expires_at:
                    type: string
                    format: date-time
                    description: Auto-delete timestamp (24 hours from creation)

              examples:
                processing:
                  summary: Still processing
                  value:
                    job_id: "pdf-12345678-1234-1234-1234-123456789012"
                    status: "processing"
                    created_at: "2025-11-08T12:35:00Z"
                    expires_at: "2025-11-09T12:35:00Z"

                completed:
                  summary: Ready for download
                  value:
                    job_id: "pdf-12345678-1234-1234-1234-123456789012"
                    status: "completed"
                    download_url: "/api/exports/pdf/pdf-12345678-1234-1234-1234-123456789012/download"
                    file_size_bytes: 3456789
                    created_at: "2025-11-08T12:35:00Z"
                    completed_at: "2025-11-08T12:35:08Z"
                    expires_at: "2025-11-09T12:35:00Z"

                failed:
                  summary: Generation failed
                  value:
                    job_id: "pdf-12345678-1234-1234-1234-123456789012"
                    status: "failed"
                    error_message: "Chart rendering failed: invalid date range"
                    created_at: "2025-11-08T12:35:00Z"
                    expires_at: "2025-11-09T12:35:00Z"

        '404':
          description: Job ID not found or expired
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /api/exports/pdf/{job_id}/download:
    get:
      summary: Download generated PDF report
      description: |
        Download the completed PDF report file.
        File auto-deletes 24 hours after creation.
      operationId: downloadPDF
      tags:
        - Exports
      parameters:
        - name: job_id
          in: path
          required: true
          schema:
            type: string
            format: uuid

      responses:
        '200':
          description: PDF file download
          content:
            application/pdf:
              schema:
                type: string
                format: binary
          headers:
            Content-Disposition:
              schema:
                type: string
                example: 'attachment; filename="rut_season_2024_report.pdf"'
            Content-Length:
              schema:
                type: integer
                example: 3456789

        '404':
          description: PDF not found (job not completed or file expired)
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /api/exports/zip:
    post:
      summary: Export detection crops as ZIP (async)
      description: |
        Create ZIP archive containing:
        - Detection crop images (JPEG, 300x300 pixels)
        - Metadata CSV (detection_id, image_id, filename, timestamp, classification, confidence, bbox, deer_id)

        Processing is asynchronous for large datasets (1000+ detections).
        Returns job_id for status polling.

        Target: <30 seconds for 1000 detections
      operationId: createZIPExport
      tags:
        - Exports
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - detection_ids
              properties:
                detection_ids:
                  type: array
                  minItems: 1
                  maxItems: 10000
                  items:
                    type: string
                    format: uuid
                  example:
                    - "det-11111111-1111-1111-1111-111111111111"
                    - "det-22222222-2222-2222-2222-222222222222"
                  description: |
                    List of detection IDs to export (max 10,000).
                    Use GET /api/seasonal/detections to get IDs.

                include_crops:
                  type: boolean
                  default: true
                  description: Include cropped detection images

                include_metadata_csv:
                  type: boolean
                  default: true
                  description: Include metadata.csv file

                crop_size:
                  type: integer
                  minimum: 128
                  maximum: 1024
                  default: 300
                  description: Crop image size in pixels (square)

            examples:
              mature_bucks_november:
                summary: Export all mature buck detections from November
                value:
                  detection_ids:
                    - "det-11111111-1111-1111-1111-111111111111"
                    - "det-22222222-2222-2222-2222-222222222222"
                  include_crops: true
                  include_metadata_csv: true
                  crop_size: 300

      responses:
        '202':
          description: Export job created
          content:
            application/json:
              schema:
                type: object
                required:
                  - job_id
                  - status
                  - total_detections
                properties:
                  job_id:
                    type: string
                    example: "zip-87654321-4321-4321-4321-210987654321"
                  status:
                    type: string
                    enum: [pending, processing]
                    example: "processing"
                  total_detections:
                    type: integer
                    example: 356
                  message:
                    type: string
                    example: "ZIP export started. Poll /api/exports/zip/{job_id} for status."
                  estimated_completion:
                    type: string
                    format: date-time

              example:
                job_id: "zip-87654321-4321-4321-4321-210987654321"
                status: "processing"
                total_detections: 356
                message: "ZIP export started. Poll /api/exports/zip/{job_id} for status."
                estimated_completion: "2025-11-08T12:35:30Z"

        '400':
          description: Invalid request (too many IDs or invalid UUIDs)
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

        '500':
          description: Server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /api/exports/zip/{job_id}:
    get:
      summary: Check ZIP export status
      description: |
        Poll this endpoint to track export progress.
        Returns processed_count for progress bar updates.
      operationId: getZIPStatus
      tags:
        - Exports
      parameters:
        - name: job_id
          in: path
          required: true
          schema:
            type: string
            format: uuid

      responses:
        '200':
          description: Job status with progress
          content:
            application/json:
              schema:
                type: object
                required:
                  - job_id
                  - status
                  - total_detections
                  - processed_count
                properties:
                  job_id:
                    type: string
                  status:
                    type: string
                    enum: [pending, processing, completed, failed, expired]
                  total_detections:
                    type: integer
                  processed_count:
                    type: integer
                    description: Detections processed so far (for progress bar)
                  progress_percent:
                    type: number
                    format: float
                    example: 67.5
                    description: (processed_count / total_detections) * 100
                  download_url:
                    type: string
                    nullable: true
                    description: Available when status='completed'
                  file_size_bytes:
                    type: integer
                    nullable: true
                  error_message:
                    type: string
                    nullable: true
                  created_at:
                    type: string
                    format: date-time
                  completed_at:
                    type: string
                    format: date-time
                    nullable: true
                  estimated_completion:
                    type: string
                    format: date-time
                    nullable: true
                    description: Based on current processing rate
                  expires_at:
                    type: string
                    format: date-time
                    description: Auto-delete timestamp (7 days from creation)

              examples:
                processing:
                  summary: Export in progress
                  value:
                    job_id: "zip-87654321-4321-4321-4321-210987654321"
                    status: "processing"
                    total_detections: 356
                    processed_count: 240
                    progress_percent: 67.4
                    created_at: "2025-11-08T12:35:00Z"
                    estimated_completion: "2025-11-08T12:35:20Z"
                    expires_at: "2025-11-15T12:35:00Z"

                completed:
                  summary: Export ready
                  value:
                    job_id: "zip-87654321-4321-4321-4321-210987654321"
                    status: "completed"
                    total_detections: 356
                    processed_count: 356
                    progress_percent: 100.0
                    download_url: "/api/exports/zip/zip-87654321.../download"
                    file_size_bytes: 45678901
                    created_at: "2025-11-08T12:35:00Z"
                    completed_at: "2025-11-08T12:35:28Z"
                    expires_at: "2025-11-15T12:35:00Z"

        '404':
          description: Job not found or expired
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /api/exports/zip/{job_id}/download:
    get:
      summary: Download ZIP archive
      description: |
        Download the completed ZIP file.
        File auto-deletes 7 days after creation.
      operationId: downloadZIP
      tags:
        - Exports
      parameters:
        - name: job_id
          in: path
          required: true
          schema:
            type: string
            format: uuid

      responses:
        '200':
          description: ZIP file download
          content:
            application/zip:
              schema:
                type: string
                format: binary
          headers:
            Content-Disposition:
              schema:
                type: string
                example: 'attachment; filename="mature_bucks_november_2024.zip"'
            Content-Length:
              schema:
                type: integer

        '404':
          description: ZIP not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

components:
  schemas:
    Error:
      type: object
      required:
        - error
      properties:
        error:
          type: string
        detail:
          type: string
        code:
          type: string
